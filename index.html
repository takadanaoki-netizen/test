<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®šæœŸãƒ†ã‚¹ãƒˆæ”»ç•¥ãƒãƒ¼ãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap');
        body { 
            font-family: 'Zen Maru Gothic', sans-serif; 
            background-color: #f8fafc; 
            color: #2d3748; 
            overflow-x: hidden;
        }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 1.5rem; }
        input[type="checkbox"]:checked + span { text-decoration: line-through; color: #a0aec0; }
        .btn-primary { background-color: #3182ce; color: white; font-weight: bold; transition: all 0.2s; }
        .btn-primary:active { transform: scale(0.95); }
        
        .progress-ring { transition: stroke-dashoffset 0.35s; transform: rotate(-90deg); transform-origin: 50% 50%; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 10px; }
        
        @media (min-width: 768px) {
            .main-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1.5rem;
                align-items: start;
            }
            .header-content {
                display: flex;
                justify-content: space-between;
                align-items: flex-end;
                margin-bottom: 2rem;
            }
        }

        .bar-segment { 
            transition: height 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        .bar-today-marker { 
            position: absolute;
            bottom: -5px;
            width: 100%;
            height: 3px;
            background-color: #3182ce;
            border-radius: 2px;
        }
        .test-period-bg {
            background-color: rgba(59, 130, 246, 0.05);
            border-radius: 4px;
        }
        
        #confirm-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
    </style>
    <script>
        let isSubmitting = false;
        function handleIframeLoad() {
            if (isSubmitting) {
                onSubmissionComplete();
            }
        }
    </script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="header-content mb-6">
            <div>
                <h1 class="text-3xl font-bold text-blue-600 flex items-center gap-2">
                    <span>ğŸ“</span> å®šæœŸãƒ†ã‚¹ãƒˆæ”»ç•¥ãƒãƒ¼ãƒˆ
                </h1>
                <div class="flex items-center gap-4 mt-4">
                    <div class="flex flex-col">
                        <label class="text-[10px] text-gray-400 font-bold ml-1 uppercase tracking-wider">Class</label>
                        <select id="user-class" class="text-sm border-b-2 border-gray-200 bg-transparent outline-none w-20 focus:border-blue-500 py-1 transition-all font-bold text-center cursor-pointer" onchange="saveData()">
                            <option value="">é¸æŠ</option>
                            <option value="1çµ„">1çµ„</option>
                            <option value="2çµ„">2çµ„</option>
                            <option value="3çµ„">3çµ„</option>
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label class="text-[10px] text-gray-400 font-bold ml-1 uppercase tracking-wider">No.</label>
                        <input type="number" id="user-number" placeholder="ç•ªå·" min="1" max="50" class="text-sm border-b-2 border-gray-200 bg-transparent outline-none w-16 focus:border-blue-500 py-1 transition-all font-bold text-center" oninput="saveData()">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-[10px] text-gray-400 font-bold ml-1 uppercase tracking-wider">Name</label>
                        <input type="text" id="user-name" placeholder="æ°åã‚’å…¥åŠ›" class="text-sm border-b-2 border-gray-200 bg-transparent outline-none w-48 focus:border-blue-500 py-1 transition-all font-bold" oninput="saveData()">
                    </div>
                </div>
            </div>
            
            <div class="mt-4 md:mt-0 flex flex-col items-end">
                <label class="text-[10px] text-gray-400 font-bold mb-1 uppercase tracking-wider">Test Period Setting</label>
                <div class="flex flex-col gap-2">
                    <div class="flex items-center gap-2 bg-white p-2 rounded-xl shadow-sm border border-gray-100">
                        <input type="date" id="test-date-start" class="text-xs outline-none" onchange="saveData()">
                        <span class="text-xs text-gray-400">ã€œ</span>
                        <input type="date" id="test-date-end" class="text-xs outline-none" onchange="saveData()">
                    </div>
                    <div id="days-badge" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg w-full text-center transition-all">
                        ãƒ†ã‚¹ãƒˆæœŸé–“ã‚’è¨­å®šã—ã¦ãã ã•ã„
                    </div>
                </div>
            </div>
        </header>

        <div class="main-grid">
            <!-- Left Column -->
            <div class="space-y-6">
                <div class="card bg-gradient-to-br from-blue-500 to-indigo-600 text-white border-none flex items-center justify-between p-6">
                    <div>
                        <h3 class="text-sm font-bold opacity-90 mb-1">æœ¬æ—¥ã®TODOé”æˆç‡</h3>
                        <div id="progress-text" class="text-5xl font-extrabold tracking-tight">0%</div>
                        <p class="text-[10px] mt-2 opacity-80 font-bold">GOAL: <span id="summary-goal">æœªè¨­å®š</span></p>
                    </div>
                    <div class="relative w-24 h-24">
                        <svg class="w-24 h-24">
                            <circle class="text-white opacity-20" stroke-width="8" stroke="currentColor" fill="transparent" r="40" cx="48" cy="48"/>
                            <circle id="progress-circle" class="text-white progress-ring" stroke-width="8" stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round" stroke="currentColor" fill="transparent" r="40" cx="48" cy="48"/>
                        </svg>
                    </div>
                </div>

                <div class="card relative overflow-hidden">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="font-bold text-sm text-gray-700 flex items-center gap-2">
                            <span>ğŸ“Š</span> ãƒ†ã‚¹ãƒˆç›´å‰14æ—¥é–“ã®æ¨ç§»
                        </h3>
                        <div class="text-right">
                            <p class="text-[10px] text-gray-400 font-bold uppercase">Graph Period Total</p>
                            <p id="graph-period-total" class="text-xl font-black text-blue-600">0åˆ†</p>
                        </div>
                    </div>
                    
                    <div id="stats-chart" class="flex items-end justify-between h-40 gap-1 px-2 border-b-2 border-gray-100 relative"></div>
                    
                    <div class="flex justify-between mt-2 px-1 flex-wrap gap-y-2">
                        <span id="chart-start-label" class="text-[9px] text-gray-400 font-bold">é–‹å§‹</span>
                        <div class="flex flex-wrap gap-2 justify-center">
                            <span class="flex items-center gap-1 text-[8px] font-bold"><span class="w-2 h-2 bg-red-500 rounded-full"></span>å›½</span>
                            <span class="flex items-center gap-1 text-[8px] font-bold"><span class="w-2 h-2 bg-blue-500 rounded-full"></span>æ•°</span>
                            <span class="flex items-center gap-1 text-[8px] font-bold"><span class="w-2 h-2 bg-yellow-400 rounded-full"></span>ç†</span>
                            <span class="flex items-center gap-1 text-[8px] font-bold"><span class="w-2 h-2 bg-green-500 rounded-full"></span>ç¤¾</span>
                            <span class="flex items-center gap-1 text-[8px] font-bold"><span class="w-2 h-2 bg-pink-400 rounded-full"></span>è‹±</span>
                            <span class="flex items-center gap-1 text-[8px] font-bold"><span class="w-2 h-2 bg-gray-400 rounded-full"></span>å®ŸæŠ€</span>
                        </div>
                        <span id="chart-end-label" class="text-[9px] text-blue-600 font-bold">ãƒ†ã‚¹ãƒˆçµ‚äº†æ—¥</span>
                    </div>
                </div>

                <div class="card border-l-4 border-blue-500">
                    <h3 class="font-bold text-sm mb-3 text-blue-600 flex items-center gap-2">
                        <span>ğŸ¯</span> ä»Šå›ã®ç›®æ¨™
                    </h3>
                    <div class="flex gap-2">
                        <input type="text" id="goal-input" placeholder="ä¾‹: æ•°å­¦ã§80ç‚¹ä»¥ä¸Š" class="flex-grow border-2 border-gray-100 rounded-xl px-4 py-3 text-sm focus:border-blue-300 outline-none transition-all">
                        <button onclick="saveGoal()" class="btn-primary px-6 rounded-xl text-sm shadow-md">ä¿å­˜</button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="font-bold text-sm mb-4 text-gray-700 flex justify-between items-center">
                        <span class="flex items-center gap-2">âœ… ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆ</span>
                        <span id="todo-count" class="text-xs bg-gray-100 px-3 py-1 rounded-full text-gray-500 font-bold">0 / 0</span>
                    </h3>
                    <div id="todo-list" class="space-y-3 mb-6 max-h-[250px] overflow-y-auto pr-2"></div>
                    <div class="bg-gray-50 p-3 rounded-2xl border border-gray-100 space-y-2">
                        <div class="flex gap-2">
                            <select id="todo-subject" class="w-24 bg-white border border-gray-200 rounded-xl px-2 py-2 text-xs outline-none focus:ring-1 focus:ring-blue-400">
                                <option>å›½èª</option><option>æ•°å­¦</option><option>ç†ç§‘</option>
                                <option>ç¤¾ä¼š</option><option>è‹±èª</option><option>å®ŸæŠ€</option>
                            </select>
                            <input type="text" id="todo-input" placeholder="ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›..." class="flex-grow bg-white border border-gray-200 rounded-xl px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-blue-400">
                            <button onclick="addTodo()" class="bg-blue-600 text-white w-10 h-10 rounded-xl font-bold flex items-center justify-center shadow-lg hover:bg-blue-700 transition-colors">+</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-6">
                <div class="card border-l-4 border-green-500">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-sm text-green-600 flex items-center gap-2">
                            <span>ğŸ“…</span> ä»Šæ—¥ã®å­¦ç¿’ã‚’è¨˜éŒ²
                        </h3>
                        <div class="text-right">
                           <span id="today-total-mins" class="text-xs font-bold bg-green-50 px-3 py-1 rounded-full text-green-700">ä»Šæ—¥: 0åˆ†</span>
                           <span id="all-time-mins" class="block text-[10px] text-gray-400 mt-1 font-bold">ç·å‹‰å¼·: 0åˆ†</span>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] text-gray-400 font-bold ml-1 uppercase">Date</label>
                                <input type="date" id="log-date" class="w-full border-2 border-gray-50 rounded-xl px-3 py-2 text-sm outline-none focus:border-green-300 bg-gray-50">
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-400 font-bold ml-1 uppercase">Subject</label>
                                <select id="log-subject" class="w-full border-2 border-gray-50 rounded-xl px-3 py-2 text-sm outline-none focus:border-green-300 bg-gray-50">
                                    <option>å›½èª</option><option>æ•°å­¦</option><option>ç†ç§‘</option>
                                    <option>ç¤¾ä¼š</option><option>è‹±èª</option><option>å®ŸæŠ€</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 font-bold ml-1 uppercase">Study Time (Minutes)</label>
                            <div class="flex items-center gap-4 bg-gray-50 p-3 rounded-xl border border-gray-50">
                                <input type="range" id="log-min-range" min="5" max="300" step="5" value="30" class="flex-grow accent-green-500" oninput="document.getElementById('log-min-text').value = this.value">
                                <div class="flex items-center gap-1">
                                    <input type="number" id="log-min-text" value="30" class="w-16 border-2 border-white rounded-lg text-center font-bold text-green-600 py-1 shadow-inner" oninput="document.getElementById('log-min-range').value = this.value">
                                    <span class="text-xs font-bold text-gray-500">åˆ†</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="saveLog()" class="w-full bg-green-500 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-green-600 active:scale-[0.98] transition-all">å­¦ç¿’å†…å®¹ã‚’ä¿å­˜</button>
                    </div>
                </div>

                <div class="card bg-gray-50 border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-sm text-gray-600">ğŸ“Š ç›´è¿‘ã®å±¥æ­´</h3>
                        <button onclick="clearDailyData()" class="text-[10px] text-gray-400 hover:text-red-400 underline transition-colors">ä»Šæ—¥ã®è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>
                    <div id="history-list" class="space-y-2 max-h-[160px] overflow-y-auto pr-1 mb-6"></div>

                    <div class="pt-4 border-t border-gray-200">
                        <h3 class="font-bold text-sm mb-3 text-purple-600 flex items-center gap-2">
                            <span>ğŸ“¤</span> å…ˆç”Ÿã¸æå‡º
                        </h3>
                        <div class="bg-purple-50 p-3 rounded-xl mb-4 border border-purple-100">
                            <p class="text-[10px] text-purple-700 font-bold mb-1 italic">Submission Preview:</p>
                            <div class="text-[11px] text-gray-600 leading-relaxed">
                                <span id="preview-info" class="font-bold">æœªè¨­å®š</span>
                            </div>
                        </div>
                        
                        <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="handleIframeLoad()"></iframe>
                        <form id="submission-form" target="hidden_iframe" method="POST">
                            <input type="hidden" id="form-entry-name">
                            <input type="hidden" id="form-entry-date">
                            <input type="hidden" id="form-entry-mins">
                            <input type="hidden" id="form-entry-total">
                            <input type="hidden" id="form-entry-prog">
                            <input type="hidden" id="form-entry-goal">
                            
                            <button type="button" onclick="submitToTeacher()" id="btn-submit" class="w-full bg-purple-600 text-white py-4 rounded-2xl shadow-xl font-bold hover:bg-purple-700 active:scale-[0.98] transition-all flex items-center justify-center gap-3">
                                <span id="submit-text">Googleãƒ•ã‚©ãƒ¼ãƒ ã¸é€ä¿¡</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                                </svg>
                            </button>
                        </form>
                    </div>
                </div>

                <div class="card border-t-4 border-gray-400 bg-gray-100/50">
                    <h3 class="font-bold text-xs text-gray-500 mb-3 flex items-center gap-2">
                        <span>ğŸ’¾</span> ãƒ‡ãƒ¼ã‚¿ç®¡ç†
                    </h3>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <button onclick="exportData()" class="flex flex-col items-center justify-center gap-1 bg-white border border-gray-200 py-3 rounded-xl hover:bg-gray-50 transition-colors shadow-sm">
                            <span class="text-xl">ğŸ“¥</span>
                            <span class="text-[10px] font-bold text-gray-600">ä¿å­˜(DL)</span>
                        </button>
                        <button onclick="document.getElementById('import-file').click()" class="flex flex-col items-center justify-center gap-1 bg-white border border-gray-200 py-3 rounded-xl hover:bg-gray-50 transition-colors shadow-sm">
                            <span class="text-xl">ğŸ“¤</span>
                            <span class="text-[10px] font-bold text-gray-600">å¾©å…ƒ(Load)</span>
                        </button>
                        <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(event)">
                    </div>
                    <button onclick="showResetModal()" class="w-full bg-white border border-red-100 text-red-500 py-2 rounded-xl text-[10px] font-bold hover:bg-red-50 transition-all flex items-center justify-center gap-2">
                        <span>â™»ï¸</span> æ¬¡ã®ãƒ†ã‚¹ãƒˆç”¨ã«åˆæœŸåŒ–
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="flex">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full mx-4 shadow-2xl">
            <h3 class="text-xl font-bold text-gray-800 mb-2">æ–°ã—ã„ãƒ†ã‚¹ãƒˆã‚’å§‹ã‚ã¾ã™ã‹ï¼Ÿ</h3>
            <p class="text-sm text-gray-500 mb-6 leading-relaxed">è¨˜éŒ²ãƒ»ç›®æ¨™ãƒ»TODOãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚ã‚¯ãƒ©ã‚¹ãƒ»ç•ªå·ãƒ»æ°åã¯ä¿æŒã•ã‚Œã¾ã™ã€‚</p>
            <div class="flex flex-col gap-3">
                <button onclick="exportData()" class="w-full bg-blue-50 text-blue-600 py-3 rounded-xl font-bold text-sm">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ç¶šè¡Œ</button>
                <button onclick="resetForNewTest()" class="w-full bg-red-500 text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-red-200">ã™ã¹ã¦æ¶ˆå»ã—ã¦åˆæœŸåŒ–</button>
                <button onclick="hideResetModal()" class="w-full bg-gray-100 text-gray-500 py-3 rounded-xl font-bold text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-8 py-3 rounded-2xl text-sm font-bold z-50 shadow-2xl transition-all duration-300 opacity-0 pointer-events-none"></div>

    <script>
        const STORAGE_KEY = 'study_planner_chromebook_v6_class_select';
        
        const SUBJECT_COLORS = {
            "å›½èª": "#ef4444", "æ•°å­¦": "#3b82f6", "ç†ç§‘": "#fbbf24", "ç¤¾ä¼š": "#22c55e", "è‹±èª": "#f472b6", "å®ŸæŠ€": "#94a3b8" 
        };

        const FORM_CONFIG = {
            url: "https://docs.google.com/forms/u/0/d/e/1FAIpQLSexj0GllhBrYr4iqCLYUsbF4jzeuBOEBnwQvdmSi7WuoXsFRw/formResponse",
            entries: {
                name: "entry.692212381", 
                date: "entry.441833019", 
                mins: "entry.666977681", 
                total: "entry.835988764",
                prog: "entry.1650053480", 
                goal: "entry.110485347"  
            }
        };

        let state = { 
            userClass: "", userNumber: "", userName: "", testDateStart: "", testDateEnd: "", goal: "", todos: [], logs: [] 
        };

        function getFormattedDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) state = JSON.parse(saved);
            document.getElementById('user-class').value = state.userClass || "";
            document.getElementById('user-number').value = state.userNumber || "";
            document.getElementById('user-name').value = state.userName || "";
            document.getElementById('test-date-start').value = state.testDateStart || "";
            document.getElementById('test-date-end').value = state.testDateEnd || "";
            document.getElementById('goal-input').value = state.goal || "";
            document.getElementById('summary-goal').innerText = state.goal || "æœªè¨­å®š";
            renderTodos(); renderLogs(); updateStats(); renderChart(); updatePreview();
        }

        function saveData() {
            state.userClass = document.getElementById('user-class').value;
            state.userNumber = document.getElementById('user-number').value;
            state.userName = document.getElementById('user-name').value;
            state.testDateStart = document.getElementById('test-date-start').value;
            state.testDateEnd = document.getElementById('test-date-end').value;
            state.goal = document.getElementById('goal-input').value;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            updateStats(); renderChart(); updatePreview();
        }

        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `å­¦ç¿’è¨˜éŒ²_${state.userClass || ''}${state.userName || 'åå‰ãªã—'}_${getFormattedDate(new Date())}.json`;
            link.click();
            showToast("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    state = JSON.parse(e.target.result);
                    saveData(); loadData();
                    showToast("ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼");
                } catch (err) { showToast("âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"); }
            };
            reader.readAsText(file);
        }

        function showResetModal() { document.getElementById('confirm-modal').style.display = 'flex'; }
        function hideResetModal() { document.getElementById('confirm-modal').style.display = 'none'; }

        function resetForNewTest() {
            state.testDateStart = "";
            state.testDateEnd = "";
            state.goal = "";
            state.todos = [];
            state.logs = [];
            saveData();
            loadData();
            hideResetModal();
            showToast("æ–°ã—ã„ãƒ†ã‚¹ãƒˆç”¨ã«åˆæœŸåŒ–ã—ã¾ã—ãŸï¼");
        }

        function renderChart() {
            const chart = document.getElementById('stats-chart');
            const startLabel = document.getElementById('chart-start-label');
            const endLabel = document.getElementById('chart-end-label');
            const totalLabel = document.getElementById('graph-period-total');
            chart.innerHTML = "";
            let endRefDate = state.testDateEnd ? new Date(state.testDateEnd) : new Date();
            let totalMins = 0;
            let dailyData = [];
            let maxDailyTotal = 60; 
            const todayStr = getFormattedDate(new Date());
            const testStart = state.testDateStart ? new Date(state.testDateStart) : null;
            const testEnd = state.testDateEnd ? new Date(state.testDateEnd) : null;

            for (let i = 13; i >= 0; i--) {
                const targetDate = new Date(endRefDate);
                targetDate.setDate(targetDate.getDate() - i);
                const dateKey = getFormattedDate(targetDate);
                const subjectSums = {};
                let dayTotal = 0;
                state.logs.filter(l => l.date === dateKey).forEach(l => {
                    subjectSums[l.subject] = (subjectSums[l.subject] || 0) + l.minutes;
                    dayTotal += l.minutes;
                });
                const isTestPeriod = testStart && testEnd && targetDate >= testStart && targetDate <= testEnd;
                dailyData.push({ date: dateKey, subjects: subjectSums, total: dayTotal, isToday: dateKey === todayStr, isTestPeriod: isTestPeriod });
                totalMins += dayTotal;
                if (dayTotal > maxDailyTotal) maxDailyTotal = dayTotal;
                if (i === 13) startLabel.innerText = `${targetDate.getMonth()+1}/${targetDate.getDate()}`;
                if (i === 0) endLabel.innerText = state.testDateEnd ? "çµ‚äº†æ—¥" : "æœ¬æ—¥";
            }
            totalLabel.innerText = `${totalMins}åˆ†`;
            dailyData.forEach(d => {
                const barContainer = document.createElement('div');
                barContainer.className = `flex-grow flex flex-col items-center group relative h-full justify-end ${d.isTestPeriod ? 'test-period-bg' : ''}`;
                const barInner = document.createElement('div');
                barInner.className = "w-full max-w-[18px] rounded-t-sm overflow-hidden flex flex-col-reverse shadow-sm";
                barInner.style.height = `${(d.total / maxDailyTotal) * 100}%`;
                ["å›½èª", "æ•°å­¦", "ç†ç§‘", "ç¤¾ä¼š", "è‹±èª", "å®ŸæŠ€"].forEach(sub => {
                    if (d.subjects[sub]) {
                        const segment = document.createElement('div');
                        segment.style.height = `${(d.subjects[sub] / d.total) * 100}%`;
                        segment.style.backgroundColor = SUBJECT_COLORS[sub];
                        barInner.appendChild(segment);
                    }
                });
                if (d.total === 0) {
                    const empty = document.createElement('div');
                    empty.className = `w-full h-[2px] ${d.isTestPeriod ? 'bg-blue-200' : 'bg-gray-100'}`;
                    barInner.appendChild(empty);
                }
                barContainer.appendChild(barInner);
                if (d.isToday) {
                    const marker = document.createElement('div');
                    marker.className = "bar-today-marker";
                    barContainer.appendChild(marker);
                }
                chart.appendChild(barContainer);
            });
        }

        function updateStats() {
            const badge = document.getElementById('days-badge');
            const now = new Date().setHours(0,0,0,0);
            if (state.testDateStart && state.testDateEnd) {
                const startDate = new Date(state.testDateStart).setHours(0,0,0,0);
                const endDate = new Date(state.testDateEnd).setHours(0,0,0,0);
                if (now < startDate) {
                    badge.innerText = `ãƒ†ã‚¹ãƒˆé–‹å§‹ã¾ã§ ã‚ã¨ ${Math.ceil((startDate - now) / 86400000)}æ—¥`;
                    badge.className = "bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg w-full text-center";
                } else if (now >= startDate && now <= endDate) {
                    badge.innerText = "âœ¨ ãƒ†ã‚¹ãƒˆæœŸé–“ä¸­ âœ¨";
                    badge.className = "bg-gradient-to-r from-red-500 to-orange-500 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg w-full text-center animate-pulse";
                } else {
                    badge.innerText = "ãƒ†ã‚¹ãƒˆçµ‚äº† ãŠç–²ã‚Œæ§˜ï¼";
                    badge.className = "bg-gray-500 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg w-full text-center";
                }
            } else {
                badge.innerText = "ãƒ†ã‚¹ãƒˆæœŸé–“ã‚’è¨­å®šã—ã¦ãã ã•ã„";
                badge.className = "bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg w-full text-center";
            }
        }

        function addTodo() {
            const subject = document.getElementById('todo-subject').value;
            const input = document.getElementById('todo-input');
            if (!input.value.trim()) return;
            state.todos.push({ id: Date.now(), subject: subject, text: input.value, done: false });
            input.value = ""; saveData(); renderTodos();
        }
        function toggleTodo(id) { state.todos = state.todos.map(t => t.id === id ? { ...t, done: !t.done } : t); saveData(); renderTodos(); }
        function deleteTodo(id) { state.todos = state.todos.filter(t => t.id !== id); saveData(); renderTodos(); }
        function renderTodos() {
            const container = document.getElementById('todo-list'); container.innerHTML = "";
            state.todos.forEach(t => {
                const item = document.createElement('div');
                item.className = "flex items-center gap-4 p-4 bg-white border border-gray-100 rounded-2xl shadow-sm";
                item.innerHTML = `<input type="checkbox" class="w-6 h-6 accent-blue-600" ${t.done ? 'checked' : ''} onchange="toggleTodo(${t.id})">
                    <div class="flex-grow flex flex-col">
                        <span class="text-[9px] font-bold uppercase" style="color: ${SUBJECT_COLORS[t.subject]}">${t.subject}</span>
                        <span class="text-sm font-bold ${t.done ? 'line-through text-gray-300' : 'text-gray-700'}">${t.text}</span>
                    </div>
                    <button onclick="deleteTodo(${t.id})" class="text-gray-300 px-2 text-xl hover:text-red-400">Ã—</button>`;
                container.appendChild(item);
            });
            const done = state.todos.filter(t => t.done).length;
            const prog = state.todos.length === 0 ? 0 : Math.round(done/state.todos.length*100);
            document.getElementById('todo-count').innerText = `${done} / ${state.todos.length}`;
            document.getElementById('progress-text').innerText = prog + "%";
            document.getElementById('progress-circle').style.strokeDashoffset = 251.2 - (prog / 100 * 251.2);
        }

        function saveLog() {
            const date = document.getElementById('log-date').value;
            const subject = document.getElementById('log-subject').value;
            const mins = parseInt(document.getElementById('log-min-text').value);
            if (!date) return showToast("âš ï¸ æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„");
            state.logs.unshift({ id: Date.now(), date, subject, minutes: mins });
            saveData(); renderLogs(); renderChart(); showToast("å­¦ç¿’ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼");
        }
        
        function renderLogs() {
            const container = document.getElementById('history-list'); container.innerHTML = "";
            state.logs.slice(0, 10).forEach(l => {
                const item = document.createElement('div');
                item.className = "flex justify-between items-center p-3 bg-white rounded-xl border border-gray-100 text-xs shadow-sm";
                item.innerHTML = `<div><span class="font-bold text-gray-700">${l.subject}</span> <span class="text-gray-400">${l.date.split('-').slice(1).join('/')}</span></div><span class="text-blue-600 font-bold">${l.minutes}åˆ†</span>`;
                container.appendChild(item);
            });
            const todayMins = state.logs.filter(l => l.date === getFormattedDate(new Date())).reduce((s, l) => s + l.minutes, 0);
            const allTimeMins = state.logs.reduce((s, l) => s + l.minutes, 0);
            document.getElementById('today-total-mins').innerText = `ä»Šæ—¥: ${todayMins}åˆ†`;
            document.getElementById('all-time-mins').innerText = `ç·å‹‰å¼·: ${allTimeMins}åˆ†`;
        }

        function saveGoal() { saveData(); document.getElementById('summary-goal').innerText = state.goal || "æœªè¨­å®š"; showToast("ç›®æ¨™ã‚’æ›´æ–°ã—ã¾ã—ãŸ"); }
        function showToast(msg) {
            const t = document.getElementById('toast'); t.innerText = msg; t.classList.remove('opacity-0'); t.classList.add('opacity-100');
            setTimeout(() => t.classList.add('opacity-0'), 3000);
        }
        function clearDailyData() { if(confirm("ä»Šæ—¥ã®è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) { const today = getFormattedDate(new Date()); state.logs = state.logs.filter(l => l.date !== today); saveData(); renderLogs(); renderChart(); } }

        function updatePreview() {
            const todayMins = state.logs.filter(l => l.date === getFormattedDate(new Date())).reduce((s, l) => s + l.minutes, 0);
            const done = state.todos.filter(t => t.done).length;
            const prog = state.todos.length === 0 ? 0 : Math.round((done / state.todos.length) * 100);
            const num = state.userNumber ? state.userNumber.toString().padStart(2, '0') : '??';
            document.getElementById('preview-info').innerHTML = `ã€${state.userClass || 'æœªé¸æŠ'} ${num}ç•ª ${state.userName || 'æœªå…¥åŠ›'}ã€‘<br>æœ¬æ—¥: ${todayMins}åˆ† / é”æˆç‡: ${prog}% / ç›®æ¨™: ${state.goal || 'æœªè¨­å®š'}`;
        }

        function submitToTeacher() {
            if (!state.userClass || !state.userNumber || !state.userName) return showToast("âš ï¸ ã‚¯ãƒ©ã‚¹ãƒ»ç•ªå·ãƒ»æ°åã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
            const btn = document.getElementById('btn-submit'); btn.disabled = true; btn.innerText = "é€ä¿¡ä¸­...";
            
            const todayMins = state.logs.filter(l => l.date === getFormattedDate(new Date())).reduce((s, l) => s + l.minutes, 0);
            const allTimeMins = state.logs.reduce((s, l) => s + l.minutes, 0);
            const done = state.todos.filter(t => t.done).length;
            const prog = state.todos.length === 0 ? 0 : Math.round((done / state.todos.length) * 100);
            
            const form = document.getElementById('submission-form');
            form.action = FORM_CONFIG.url;
            
            const num = state.userNumber.toString().padStart(2, '0');
            document.getElementById('form-entry-name').name = FORM_CONFIG.entries.name;
            document.getElementById('form-entry-name').value = `${state.userClass} ${num}ç•ª ${state.userName}`;
            
            document.getElementById('form-entry-date').name = FORM_CONFIG.entries.date;
            document.getElementById('form-entry-date').value = getFormattedDate(new Date());
            
            document.getElementById('form-entry-mins').name = FORM_CONFIG.entries.mins;
            document.getElementById('form-entry-mins').value = todayMins;

            document.getElementById('form-entry-total').name = FORM_CONFIG.entries.total;
            document.getElementById('form-entry-total').value = allTimeMins;
            
            document.getElementById('form-entry-prog').name = FORM_CONFIG.entries.prog;
            document.getElementById('form-entry-prog').value = prog + "%";
            
            document.getElementById('form-entry-goal').name = FORM_CONFIG.entries.goal;
            document.getElementById('form-entry-goal').value = state.goal || "æœªè¨­å®š";
            
            isSubmitting = true; 
            form.submit();
        }

        function onSubmissionComplete() {
            showToast("é€ä¿¡å®Œäº†ï¼");
            const btn = document.getElementById('btn-submit');
            btn.disabled = false; btn.innerText = "Googleãƒ•ã‚©ãƒ¼ãƒ ã¸é€ä¿¡";
            isSubmitting = false;
        }

        window.onload = () => {
            document.getElementById('log-date').value = getFormattedDate(new Date());
            loadData();
        };
    </script>
</body>
</html>
